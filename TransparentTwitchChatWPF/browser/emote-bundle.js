(()=>{"use strict";const t=new Map,e=new Map,o=new Map;function s(t){console.log("Emotes found, setting up and synchronizing animations...");const e=[];t.forEach(o=>{o.style.visibility="hidden";const s=()=>{o.removeEventListener("load",s),o.decode().then(()=>{o.style.visibility="visible",e.push(o),e.length===t.length&&setTimeout(()=>{!function(t){console.log("Synchronizing animations..."),t.forEach(t=>{t.width>0&&t.height>0&&(t.setAttribute("data-original-width",t.width),t.setAttribute("data-original-height",t.height));const e=t.width||t.offsetWidth,o=t.height||t.offsetHeight;e>0&&o>0&&(t.style.width=`${e}px`,t.style.height=`${o}px`)});const e=Date.now(),o=t.map(t=>new Promise(o=>{const s=t.src,n=s.includes("?")?"&":"?",c=`${s}${n}_sync=${e}`,i=new Image;i.onload=()=>o({img:t,newSrc:c}),i.src=c}));Promise.all(o).then(t=>{t.forEach(({img:t,newSrc:e})=>{t.src=e,setTimeout(()=>{t.style.width="",t.style.height=""},50)})})}(e)},50)}).catch(t=>{})};o.addEventListener("load",s)})}async function n(){try{const t=await fetch("https://api.betterttv.net/3/cached/emotes/global");(await t.json()||[]).forEach(t=>{e.set(t.code,{id:t.id,url:`https://cdn.betterttv.net/emote/${t.id}/1x`,source:"bttv_global"})})}catch(t){console.error("Failed to fetch BTTV global emotes:",t)}}async function c(){try{const t=await fetch("https://api.frankerfacez.com/v1/set/global"),e=await t.json();if(e.sets)for(const t of Object.values(e.sets))(t.emoticons||[]).forEach(t=>{o.set(t.name,{id:t.id,url:`https:${t.urls[1]}`,source:"ffz_global"})})}catch(t){console.error("Failed to fetch FFZ global emotes:",t)}}async function i(){try{const e=await fetch("https://7tv.io/v3/emote-sets/global");((await e.json()).emotes||[]).forEach(e=>{t.set(e.name,{id:e.id,url:`https://cdn.7tv.app/emote/${e.data.id}/1x.webp`,source:"7tv_global"})})}catch(t){console.error("Failed to fetch 7TV global emotes:",t)}}window.emoteManager={init:async function(a){console.log(`Initializing emotes for channel: ${a}`);const r=await async function(t){try{const e=await fetch(`https://api.ivr.fi/v2/twitch/user?login=${t}`);if(!e.ok)throw new Error(`Failed to fetch user ID for ${t}`);const o=await e.json();return o[0]?.id}catch(t){return console.error("Error getting Twitch User ID:",t),null}}(a),l=[n(),c(),i()];r?(console.log(`Found Twitch User ID: ${r}`),l.push(async function(t){try{const o=await fetch(`https://api.betterttv.net/3/cached/users/twitch/${t}`),s=await o.json();(s.channelEmotes||[]).concat(s.sharedEmotes||[]).forEach(t=>{e.set(t.code,{id:t.id,url:`https://cdn.betterttv.net/emote/${t.id}/1x`,source:"bttv"})})}catch(t){console.error("Failed to fetch BTTV channel emotes:",t)}}(r),async function(t){try{const e=await fetch(`https://api.frankerfacez.com/v1/room/${t}`),s=await e.json();if(s.sets)for(const t of Object.values(s.sets))(t.emoticons||[]).forEach(t=>{o.set(t.name,{id:t.id,url:`https:${t.urls[1]}`,source:"ffz"})})}catch(t){console.error("Failed to fetch FFZ channel emotes:",t)}}(a),async function(e){try{const o=await fetch(`https://7tv.io/v3/users/twitch/${e}`),s=await o.json(),n=s.emote_set?.emotes;n&&n.forEach(e=>{t.set(e.name,{id:e.id,url:`https://cdn.7tv.app/emote/${e.data.id}/1x.webp`,source:"7tv"})})}catch(t){console.error("Failed to fetch 7TV channel emotes:",t)}}(r))):console.error("Could not get Twitch User ID. Only fetching global emotes."),await Promise.all(l),console.log(`All emote fetching complete. Total Emotes Loaded: 7TV=${t.size}, BTTV=${e.size}, FFZ=${o.size}`),function(){console.log("Chat container found, observing...");const t=document.getElementById("chat_container");t&&new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)if(1===t.nodeType&&t.classList.contains("chat_line")){const e=Array.from(t.querySelectorAll(".emote"));e.length>1&&s(e)}}).observe(t,{childList:!0,subtree:!0})}()},replace:function(t,e){let o=t.split(" "),s=[];return o.forEach(t=>{let o=e.get(t);if(o){let e=o.url;"7tv"==o.source&&(e=`https://cdn.7tv.app/emote/${o.id}/1x.webp`),s.push(`<img class="emote" src="${e}" alt="${t}" title="${t}">`)}else s.push(t)}),s.join(" ")},getEmoteMaps:()=>({sevenTV:t,bttv:e,ffz:o})}})();